name: Run MLflow (Vegetables)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - ".workflow/mlflow.yml"
      - ".github/workflows/mlflow.yml"
  pull_request:
    branches: ["main"]

permissions:
  contents: write

jobs:
  mlflow:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install mlflow

      - name: Run MLflow Project
        run: |
          cd "Workflow-CI/MLProject"
          export MLFLOW_TRACKING_URI="file:$(pwd)/mlruns"
          mlflow run . \
            --env-manager=local \
            -P max_train=200 \
            -P max_test=100 \
            -P batch_size=64 \
            -P device=cpu | tee mlflow_output.txt
      
          RUN_ID=$(grep "MLFLOW_RUN_ID=" mlflow_output.txt | tail -1 | cut -d'=' -f2)
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "MLFLOW_TRACKING_URI=$MLFLOW_TRACKING_URI" >> $GITHUB_ENV
          echo "Captured run ID: $RUN_ID"

      - name: Build Docker image from MLflow model
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          cd "Workflow-CI/MLProject"
          python -m mlflow models build-docker \
            --model-uri "runs:/${RUN_ID}/model" \
            --name "${DOCKERHUB_USERNAME}/vegetables-mlflow:latest"

      - name: Push Docker image
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: docker push "${DOCKERHUB_USERNAME}/vegetables-mlflow:latest"

      - name: Upload MLflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-artifacts
          path: Workflow-CI/MLProject/mlruns/
          retention-days: 30
          if-no-files-found: error
