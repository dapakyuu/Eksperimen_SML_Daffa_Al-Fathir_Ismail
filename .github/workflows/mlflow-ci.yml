name: MLflow CI - Vegetables

on:
  push:
    branches: [main]
    paths:
      - "Workflow-CI/MLProject/**"
      - "Workflow-CI/.github/workflows/**"
      - "Eksperimen_MSML_Daffa_Al-Fathir_Ismail/preprocessing/**"
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow pandas numpy scikit-learn matplotlib seaborn pillow kagglehub torch torchvision

      - name: Setup Kaggle API
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
        run: |
          mkdir -p ~/.kaggle
          echo "{\"username\":\"$KAGGLE_USERNAME\",\"key\":\"$KAGGLE_KEY\"}" > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      - name: Download dataset from Kaggle
        run: |
          python - << 'PY'
          import kagglehub
          import os
          import shutil

          print('Downloading Vegetable Image Dataset from Kaggle...')
          path = kagglehub.dataset_download('misrakahmed/vegetable-image-dataset')
          print(f'Downloaded to: {path}')

          target = 'Workflow-CI/MLProject/Vegetables_raw'
          if os.path.exists(target):
              shutil.rmtree(target)
          os.makedirs(os.path.dirname(target), exist_ok=True)

          nested = os.path.join(path, 'Vegetable Images')
          if os.path.exists(nested):
              shutil.move(nested, target)
          else:
              shutil.move(path, target)

          print(f'Dataset ready at: {target}')
          PY

      - name: Run MLflow Project and capture run ID
        run: |
          cd "Workflow-CI/MLProject"
          export MLFLOW_TRACKING_URI="file:$(pwd)/mlruns"
          python -m mlflow run . \
            --env-manager=local \
            --experiment-name "Vegetables-CI" \
            -P max_train=200 \
            -P max_test=100 \
            -P batch_size=64 \
            -P device=cpu > mlflow_output.txt 2>&1
          cat mlflow_output.txt
          RUN_ID=$(grep "MLFLOW_RUN_ID=" mlflow_output.txt | tail -1 | cut -d'=' -f2)
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "MLFLOW_TRACKING_URI=$MLFLOW_TRACKING_URI" >> $GITHUB_ENV
          echo "Captured run ID: $RUN_ID"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image with mlflow build-docker
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          cd "Workflow-CI/MLProject"
          python -m mlflow models build-docker \
            --model-uri "runs:/${RUN_ID}/model" \
            --name "${DOCKERHUB_USERNAME}/vegetables-mlflow:latest"

      - name: Push Docker image
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          docker push "${DOCKERHUB_USERNAME}/vegetables-mlflow:latest"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-artifacts
          path: |
            Workflow-CI/MLProject/mlruns/
            Workflow-CI/MLProject/*.png
            Workflow-CI/MLProject/*.txt
          retention-days: 30
